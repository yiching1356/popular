<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† å®œæ…¶åœ°æ”¿äººæ°£ç‹çˆ­éœ¸æˆ°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --yiqing-main: #215440; --yiqing-gold: #d4af37; }
        [v-cloak] { display: none; }
        body { font-family: "PingFang TC", sans-serif; background: #f0f4f2; margin: 0; padding: 20px; }
        .vote-card { width: 100%; max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 20px; }
        .timer { background: var(--yiqing-main); color: #ffca28; padding: 10px; border-radius: 15px; text-align: center; font-weight: bold; margin-bottom: 20px; }
        .candidate-item { border: 1px solid #eee; padding: 15px; border-radius: 20px; margin-bottom: 10px; }
        .vote-btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-ready { background: var(--yiqing-main); color: white; }
        .btn-voted { background: #e8f5e9; color: #2e7d32; }
        .btn-others { background: #f8fafc; color: #94a3b8; }
        .footer { text-align: center; font-size: 11px; color: #94a3b8; margin-top: 20px; }
    </style>
</head>
<body>
<div id="app" class="vote-card" v-cloak>
    <div class="header">
        <h1>ğŸ† å®œæ…¶åœ°æ”¿äººæ°£ç‹</h1>
        <p>âœ¨ æ¯äººæ¯å¤©å¯æŠ•ä¸€ç¥¨ âœ¨</p>
    </div>

    <div class="timer">â³ å€’æ•¸ï¼š{{ countdownText }}</div>

    <div v-for="(p, index) in sortedPlayers" :key="p.name" class="candidate-item">
        <div style="display: flex; justify-content: space-between; font-weight: bold;">
            <span>{{ p.name }}</span>
            <span>{{ p.votes }} ç¥¨</span>
        </div>
        
        <template v-if="!isExpired">
            <button v-if="!hasVotedToday" class="vote-btn btn-ready" @click="handleVote(p.name)">
                ğŸ‘ æŠ•çµ¦ä»– (ä»Šæ—¥å‰© 1 ç¥¨)
            </button>
            
            <button v-else class="vote-btn" 
                    :class="votedTarget === p.name ? 'btn-voted' : 'btn-others'" 
                    @click="showAlreadyVotedAlert">
                {{ votedTarget === p.name ? 'âœ… ä»Šæ—¥å·²æŠ•ç¥¨' : 'æ˜å¤©å†ä¾†æŠ•æˆ‘' }}
            </button>
        </template>
    </div>

    <div class="footer">ç³»çµ±æœƒè¨˜éŒ„è£ç½®ç‰¹å¾µï¼Œåš´ç¦çŒç¥¨ã€‚</div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBof1GHVYDUHqcsNQWW7grVNNxT_mt8sqA",
        authDomain: "yiqing-vote.firebaseapp.com",
        databaseURL: "https://yiqing-vote-default-rtdb.firebaseio.com",
        projectId: "yiqing-vote",
        storageBucket: "yiqing-vote.firebasestorage.app",
        messagingSenderId: "717925770555",
        appId: "1:717925770555:web:a2554db9a8e2ffe110031e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const votesRef = db.ref('yiqing_FINAL_VOTES_2026');
    const logsRef = db.ref('yiqing_VOTE_LOGS_2026');

    // å–å¾—ä»Šæ—¥æ—¥æœŸå­—ä¸² (ä¾‹å¦‚ "2026-02-03")
    function getTodayStr() {
        return new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g, '-');
    }

    function getDeviceFingerprint() {
        const specs = [navigator.userAgent.length, screen.width + "x" + screen.height, navigator.language];
        return "DEV-" + btoa(specs.join("|")).substring(0, 16);
    }

    const { createApp } = Vue;
    createApp({
        data() {
            const today = getTodayStr();
            const savedDate = localStorage.getItem('voted_date');
            return {
                // å¦‚æœå­˜æª”æ—¥æœŸç­‰æ–¼ä»Šå¤©ï¼Œå°±æ˜¯å·²æŠ•é
                hasVotedToday: savedDate === today,
                votedTarget: localStorage.getItem('voted_target_today'),
                playersData: { 'æ°¸åº·æ‰€ âœ¦ å­ç³æ‰€é•·': 0, 'è¯å¹³æ‰€ âœ¦ ç‘œèæ‰€é•·': 0, 'å®‰å¹³æ‰€ âœ¦ ç§€å¦‚æ‰€é•·': 0, 'å–„åŒ–æ‰€ âœ¦ ææ•æ‰€é•·': 0, 'æ©‹é ­æ‰€ âœ¦ æƒ å©·æ‰€é•·': 0, 'å˜‰ç¾©æ‰€ âœ¦ ç¾ä¼¶æ‰€é•·': 0, 'ç¸½æ‰€ âœ¦ ç…’æ¾‚çµ„': 0, 'ç¸½æ‰€ âœ¦ ä½©åº­çµ„': 0, 'å»ºè¨­éƒ¨': 0 },
                endTime: new Date("2026-03-06T12:00:00").getTime(),
                countdownText: "", isExpired: false, isChecking: false
            }
        },
        mounted() {
            this.refreshData();
            this.updateTimer();
            setInterval(this.updateTimer, 1000);
        },
        computed: {
            sortedPlayers() { return Object.keys(this.playersData).map(n => ({ name: n, votes: this.playersData[n] })).sort((a, b) => b.votes - a.votes); }
        },
        methods: {
            refreshData() { votesRef.get().then((s) => { const data = s.val(); if (data) this.playersData = {...this.playersData, ...data}; }); },
            updateTimer() {
                const diff = this.endTime - new Date().getTime();
                if (diff <= 0) { this.countdownText = "æŠ•ç¥¨å·²çµæŸ"; this.isExpired = true; return; }
                const d = Math.floor(diff / 86400000), h = Math.floor((diff % 86400000) / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
                this.countdownText = `${d}å¤© ${h}:${m}:${s}`;
            },
            showAlreadyVotedAlert() {
                alert("æ‚¨ä»Šå¤©å·²ç¶“æŠ•éç¥¨å›‰ï¼\nè«‹æ˜å¤©å†éä¾†æ”¯æŒæˆ‘å€‘ ğŸ˜Š");
            },
            async handleVote(name) {
                if (this.hasVotedToday || this.isChecking) return;
                this.isChecking = true;

                const today = getTodayStr();
                const deviceID = getDeviceFingerprint();
                
                try {
                    // åŒæ™‚æª¢æŸ¥è£ç½® ID èˆ‡ æ—¥æœŸ
                    const snapshot = await logsRef.orderByChild('deviceID').equalTo(deviceID).get();
                    let alreadyVoted = false;
                    
                    snapshot.forEach(child => {
                        if (child.val().date === today) alreadyVoted = true;
                    });

                    if (alreadyVoted) {
                        this.showAlreadyVotedAlert();
                        this.hasVotedToday = true;
                        localStorage.setItem('voted_date', today);
                    } else {
                        // åŸ·è¡ŒæŠ•ç¥¨
                        await votesRef.child(name).transaction(v => (v || 0) + 1);
                        await logsRef.push({ 
                            target: name, 
                            deviceID: deviceID, 
                            date: today,
                            time: new Date().toLocaleString() 
                        });

                        this.hasVotedToday = true;
                        this.votedTarget = name;
                        localStorage.setItem('voted_date', today);
                        localStorage.setItem('voted_target_today', name);
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                        this.refreshData();
                    }
                } catch (e) { console.error(e); }
                finally { this.isChecking = false; }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
