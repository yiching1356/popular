<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† å®œæ…¶åœ°æ”¿äººæ°£ç‹çˆ­éœ¸æˆ°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --yiqing-main: #215440; --yiqing-light: #2d6a53; --yiqing-gold: #d4af37; }
        [v-cloak] { display: none; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: radial-gradient(circle at top right, #f0f4f2 0%, #d9e2dd 100%); margin: 0; padding: 20px; color: #2c3e50; min-height: 100vh; }
        .vote-card { width: 100%; max-width: 500px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 35px 25px; border-radius: 40px; box-shadow: 0 20px 60px rgba(33, 84, 64, 0.1); border: 1px solid rgba(255,255,255,0.5); }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--yiqing-main); font-size: 28px; font-weight: 900; margin: 0; }
        .countdown-container { background: var(--yiqing-main); color: white; padding: 15px; border-radius: 20px; text-align: center; margin: 25px 0; }
        .timer { font-family: 'Inter', monospace; font-size: 22px; font-weight: 800; color: #ffca28; }
        .candidate-item { background: white; border: 1px solid #edf2f0; padding: 20px; border-radius: 24px; margin-bottom: 15px; transition: 0.4s; position: relative; }
        .is-leading { border: 1px solid var(--yiqing-gold); }
        .info-row { display: flex; justify-content: space-between; align-items: center; }
        .name { font-weight: 800; font-size: 17px; color: var(--yiqing-main); }
        .rank-tag { font-size: 12px; margin-left: 8px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .rank-1 { color: #d4af37; background: #fff9e6; }
        .rank-2 { color: #7f8c8d; background: #f5f5f5; }
        .rank-3 { color: #a67c52; background: #fff3e6; }
        .vote-stats { font-weight: 900; color: #1a1a1a; font-size: 20px; }
        .progress-track { height: 8px; background: #f0f4f2; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: var(--yiqing-main); transition: width 1.2s ease; }
        .vote-btn { width: 100%; padding: 14px; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 15px; outline: none; -webkit-tap-highlight-color: transparent; }
        .btn-ready { background: var(--yiqing-main); color: white; }
        .btn-ready:active { transform: scale(0.98); background: var(--yiqing-light); }
        .btn-voted-target { background: #e8f5e9; color: #2e7d32; }
        .btn-unvoted { background: #f8fafc; color: #94a3b8; border: 1px solid #f1f5f9; }
        .footer { text-align: center; font-size: 11px; color: #94a3b8; margin-top: 35px; line-height: 1.6; }
        .warning-text { color: #e53935; font-weight: bold; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>
<div id="app" class="vote-card" v-cloak>
    <div class="header">
        <h1>ğŸ† å®œæ…¶åœ°æ”¿äººæ°£ç‹</h1>
        <div style="font-size: 14px; color: #5d7069; margin-top: 10px;">âœ¨ <b>æ¯äººæ¯å¤©å¯æŠ•ä¸€ç¥¨</b>ï¼Œå¿«æ”¯æŒå–œæ­¡çš„åœ˜éšŠï¼ âœ¨</div>
    </div>

    <div class="countdown-container">
        <div style="font-size: 12px; opacity: 0.9;">æŠ•ç¥¨æˆªæ­¢å€’æ•¸</div>
        <div class="timer">{{ countdownText }}</div>
    </div>

    <div v-for="(p, index) in sortedPlayers" :key="p.name" class="candidate-item" :class="{'is-leading': index < 3 && p.votes > 0}">
        <div class="info-row">
            <span class="name">{{ p.name }}
                <span v-if="index === 0 && p.votes > 0" class="rank-tag rank-1">ğŸ† é ˜å…ˆä¸­</span>
                <span v-else-if="index === 1 && p.votes > 0" class="rank-tag rank-2">ğŸ¥ˆ ç¬¬äºŒå</span>
                <span v-else-if="index === 2 && p.votes > 0" class="rank-tag rank-3">ğŸ¥‰ ç¬¬ä¸‰å</span>
            </span>
            <span class="vote-stats">{{ p.votes }} <small style="font-size: 12px;">ç¥¨</small></span>
        </div>
        
        <div class="progress-track">
            <div class="progress-fill" :style="{ width: getPercent(p.votes) + '%' }"></div>
        </div>

        <template v-if="!isExpired">
            <button v-if="!hasVotedToday" class="vote-btn btn-ready" @click="handleVote(p.name)">
                ğŸ‘ è«‹æ”¯æŒæˆ‘å€‘ï¼æŠ•ä¸€ç¥¨
            </button>
            
            <button v-else 
                    class="vote-btn" 
                    :class="votedTarget === p.name ? 'btn-voted-target' : 'btn-unvoted'" 
                    @click="showAlreadyVotedAlert">
                {{ votedTarget === p.name ? 'ğŸ‰ ä»Šæ—¥å·²æ”¯æŒï¼' : 'æ˜å¤©å†ä¾†æ”¯æŒæˆ‘' }}
            </button>
        </template>
        
        <button v-else class="vote-btn" style="background: #f1f5f9; color: #cbd5e1; cursor: not-allowed;">
            æ´»å‹•å·²æˆªæ­¢
        </button>
    </div>

    <div class="footer">
        <span class="warning-text">âš ï¸ ç³»çµ±ç›£æ§ä¸­ï¼Œåš´ç¦æƒ¡æ„çŒç¥¨ã€‚</span>
        Â© 2026 LIN LANDER MARKETING | ç¸½ç¥¨æ•¸ï¼š{{ totalVotes }}
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBof1GHVYDUHqcsNQWW7grVNNxT_mt8sqA",
        authDomain: "yiqing-vote.firebaseapp.com",
        databaseURL: "https://yiqing-vote-default-rtdb.firebaseio.com",
        projectId: "yiqing-vote",
        storageBucket: "yiqing-vote.firebasestorage.app",
        messagingSenderId: "717925770555",
        appId: "1:717925770555:web:a2554db9a8e2ffe110031e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const votesRef = db.ref('yiqing_FINAL_VOTES_2026');
    const logsRef = db.ref('yiqing_VOTE_LOGS_2026');

    function getTodayStr() {
        return new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g, '-');
    }

    function getDeviceFingerprint() {
        const specs = [navigator.userAgent.length, screen.width + "x" + screen.height, new Date().getTimezoneOffset(), navigator.language, navigator.platform];
        return "DEV-" + btoa(specs.join("|")).substring(0, 16);
    }

    const { createApp } = Vue;
    createApp({
        data() {
            const today = getTodayStr();
            const savedDate = localStorage.getItem('voted_date_2026');
            return {
                hasVotedToday: savedDate === today,
                votedTarget: localStorage.getItem('voted_target_today'),
                playersData: { 'æ°¸åº·æ‰€ âœ¦ å­ç³æ‰€é•·': 0, 'è¯å¹³æ‰€ âœ¦ ç‘œèæ‰€é•·': 0, 'å®‰å¹³æ‰€ âœ¦ ç§€å¦‚æ‰€é•·': 0, 'å–„åŒ–æ‰€ âœ¦ ææ•æ‰€é•·': 0, 'æ©‹é ­æ‰€ âœ¦ æƒ å©·æ‰€é•·': 0, 'å˜‰ç¾©æ‰€ âœ¦ ç¾ä¼¶æ‰€é•·': 0, 'ç¸½æ‰€ âœ¦ ç…’æ¾‚çµ„': 0, 'ç¸½æ‰€ âœ¦ ä½©åº­çµ„': 0, 'å»ºè¨­éƒ¨': 0 },
                endTime: new Date("2026-03-06T12:00:00").getTime(),
                countdownText: "", isExpired: false, isChecking: false
            }
        },
        mounted() {
            this.refreshData();
            this.updateTimer();
            setInterval(this.updateTimer, 1000);
            setInterval(this.refreshData, 10000);
        },
        computed: {
            sortedPlayers() { return Object.keys(this.playersData).map(n => ({ name: n, votes: this.playersData[n] })).sort((a, b) => b.votes - a.votes); },
            totalVotes() { return Object.values(this.playersData).reduce((a, b) => a + b, 0); }
        },
        methods: {
            refreshData() { votesRef.get().then((s) => { const data = s.val(); if (data) Object.keys(this.playersData).forEach(k => { if(data[k] !== undefined) this.playersData[k] = data[k] }); }); },
            getPercent(v) { return this.totalVotes === 0 ? 0 : ((v / this.totalVotes) * 100).toFixed(1); },
            updateTimer() {
                const now = new Date().getTime();
                const diff = this.endTime - now;
                if (diff <= 0) { this.countdownText = "æŠ•ç¥¨å·²çµæŸ"; this.isExpired = true; return; }
                const d = Math.floor(diff / (1000 * 60 * 60 * 24)), h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)), m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)), s = Math.floor((diff % (1000 * 60)) / 1000);
                this.countdownText = `${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
            },
            showAlreadyVotedAlert() {
                alert("æ‚¨ä»Šå¤©å·²ç¶“æŠ•éç¥¨å›‰ï¼\nè«‹æ˜å¤©å†éä¾†æ”¯æŒæˆ‘å€‘ ğŸ˜Š");
            },
            async handleVote(name) {
                if (this.hasVotedToday || this.isChecking) { this.showAlreadyVotedAlert(); return; }
                if (this.isExpired) return;

                this.isChecking = true;
                const today = getTodayStr();
                const deviceID = getDeviceFingerprint();
                
                try {
                    const snapshot = await logsRef.orderByChild('deviceID').equalTo(deviceID).get();
                    let alreadyVoted = false;
                    snapshot.forEach(child => {
                        if (child.val().date === today) alreadyVoted = true;
                    });

                    if (alreadyVoted) {
                        this.showAlreadyVotedAlert();
                        this.hasVotedToday = true;
                        localStorage.setItem('voted_date_2026', today);
                        this.isChecking = false;
                        return;
                    }

                    // åŸ·è¡ŒæŠ•ç¥¨äº¤æ˜“
                    await votesRef.child(name).transaction(v => (v || 0) + 1);
                    
                    // å¯«å…¥è©³ç´° Logï¼šåŒ…å«æ—¥æœŸã€ä¼ºæœå™¨æ™‚é–“æˆ³ã€ä»¥åŠå¯è®€æ™‚é–“å­—ä¸²
                    await logsRef.push({ 
                        target: name, 
                        deviceID: deviceID, 
                        date: today,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        fullTime: new Date().toLocaleString(), // è®“å¾Œå°ç›´æ¥çœ‹å¾—åˆ°æ™‚é–“
                        timeString: new Date().toLocaleString() // ç›¸å®¹æ€§æ¬„ä½
                    });

                    this.hasVotedToday = true;
                    this.votedTarget = name;
                    localStorage.setItem('voted_date_2026', today);
                    localStorage.setItem('voted_target_today', name);
                    
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#215440', '#d4af37'] });
                    this.refreshData();
                } catch (e) {
                    console.error("æŠ•ç¥¨ç™¼ç”ŸéŒ¯èª¤:", e);
                    alert("æŠ•ç¥¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œå†è©¦ä¸€æ¬¡");
                } finally {
                    this.isChecking = false;
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
