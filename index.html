<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† å®œæ…¶åœ°æ”¿äººæ°£ç‹çˆ­éœ¸æˆ°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --yiqing-main: #215440;
            --yiqing-light: #2d6a53;
            --yiqing-gold: #d4af37;
            --rank1: #fff9c4; /* é‡‘ */
            --rank2: #f5f5f5; /* éŠ€ */
            --rank3: #fff3e0; /* éŠ… */
        }
        [v-cloak] { display: none; }
        body { 
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; 
            background: radial-gradient(circle at top right, #f0f4f2 0%, #d9e2dd 100%);
            margin: 0; padding: 20px; color: #2c3e50; min-height: 100vh;
        }
        .vote-card { 
            width: 100%; max-width: 500px; margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 35px 25px; border-radius: 40px; 
            box-shadow: 0 20px 60px rgba(33, 84, 64, 0.1);
            border: 1px solid rgba(255,255,255,0.5);
        }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--yiqing-main); font-size: 28px; font-weight: 900; margin: 0; }
        .countdown-container { 
            background: var(--yiqing-main); color: white; padding: 15px; border-radius: 20px;
            text-align: center; margin: 25px 0;
        }
        .timer { font-family: 'Inter', monospace; font-size: 22px; font-weight: 800; color: #ffca28; }
        
        /* åˆ—è¡¨æ’åºå‹•ç•« */
        .list-move { transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .candidate-item { 
            background: white; border: 1px solid #edf2f0; padding: 20px; border-radius: 24px; 
            margin-bottom: 15px; transition: 0.4s; position: relative;
        }

        /* --- å‰ä¸‰åç‰¹æ®Šæ¨£å¼ --- */
        .rank-0 { background: var(--rank1); border: 2px solid #fbc02d; }
        .rank-1 { background: var(--rank2); border: 2px solid #bdbdbd; }
        .rank-2 { background: var(--rank3); border: 2px solid #ffb74d; }

        .info-row { display: flex; justify-content: space-between; align-items: center; }
        .name { font-weight: 800; font-size: 17px; color: var(--yiqing-main); }
        .vote-stats { font-weight: 900; color: #1a1a1a; font-size: 20px; }
        
        .progress-track { height: 8px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: var(--yiqing-main); transition: width 1.2s ease; }
        
        .vote-btn { 
            width: 100%; padding: 14px; border: none; border-radius: 15px; 
            font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 15px;
        }
        .btn-ready { background: var(--yiqing-main); color: white; }
        .btn-voted-target { background: #e8f5e9; color: #2e7d32; cursor: default; }
        .btn-unvoted { background: rgba(0,0,0,0.05); color: #94a3b8; cursor: default; }
        
        .footer { text-align: center; font-size: 11px; color: #94a3b8; margin-top: 35px; line-height: 1.6; }
        .warning-text { color: #e53935; font-weight: bold; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div id="app" class="vote-card" v-cloak>
    <div class="header">
        <h1>ğŸ† å®œæ…¶åœ°æ”¿äººæ°£ç‹</h1>
        <div style="font-size: 14px; color: #5d7069; margin-top: 10px;">æ­¡è¿æŠ•ä¸‹å–œæ­¡çš„åœ˜éšŠï¼Œç‚ºä»–å€‘çˆ­å–æ¦®è€€ï¼</div>
    </div>

    <div class="countdown-container">
        <div style="font-size: 12px; opacity: 0.9;">æŠ•ç¥¨æˆªæ­¢å€’æ•¸</div>
        <div class="timer">{{ countdownText }}</div>
    </div>

    <transition-group name="list" tag="div">
        <div v-for="(p, index) in sortedPlayers" :key="p.name" 
             class="candidate-item" 
             :class="'rank-' + index">
            
            <div class="info-row">
                <span class="name">
                    <span v-if="index === 0">ğŸ¥‡ </span>
                    <span v-if="index === 1">ğŸ¥ˆ </span>
                    <span v-if="index === 2">ğŸ¥‰ </span>
                    {{ p.name }}
                </span>
                <span class="vote-stats">{{ p.votes }} <small style="font-size: 12px;">ç¥¨</small></span>
            </div>
            
            <div class="progress-track">
                <div class="progress-fill" :style="{ width: getPercent(p.votes) + '%' }"></div>
            </div>
            
            <template v-if="!isExpired">
                <button v-if="!hasVoted" class="vote-btn btn-ready" @click="handleVote(p.name)">ğŸ‘ æŠ•çµ¦æˆ‘å€‘</button>
                <button v-else-if="votedTarget === p.name" class="vote-btn btn-voted-target">ğŸ‰ å·²æ”¯æŒ</button>
                <button v-else class="vote-btn btn-unvoted">å·²æŠ•ç¥¨</button>
            </template>
        </div>
    </transition-group>

    <div class="footer">
        <span class="warning-text">âš ï¸ ç‚ºç¶­è­·å…¬å¹³æ€§ï¼Œç³»çµ±è¨­æœ‰ç•°å¸¸ç›£æ§æ©Ÿåˆ¶ï¼Œè‹¥åµæ¸¬åˆ°æƒ¡æ„çŒç¥¨ï¼Œä¸»è¾¦å–®ä½ä¿ç•™æ‰£é™¤ç•°å¸¸ç¥¨æ•¸ä¹‹æ¬Šåˆ©ã€‚</span>
        Â© 2026 YIQING LAND ADMINISTRATION | ç¸½ç¥¨æ•¸ï¼š{{ totalVotes }}
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBof1GHVYDUHqcsNQWW7grVNNxT_mt8sqA",
        authDomain: "yiqing-vote.firebaseapp.com",
        databaseURL: "https://yiqing-vote-default-rtdb.firebaseio.com",
        projectId: "yiqing-vote",
        storageBucket: "yiqing-vote.firebasestorage.app",
        messagingSenderId: "717925770555",
        appId: "1:717925770555:web:a2554db9a8e2ffe110031e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const votesRef = db.ref('yiqing_FINAL_VOTES_2026');
    const logsRef = db.ref('yiqing_VOTE_LOGS_2026');

    const { createApp } = Vue;
    createApp({
        data() {
            return {
                hasVoted: !!localStorage.getItem('voted_FINAL_2026'),
                votedTarget: localStorage.getItem('voted_target_FINAL'),
                playersData: {
                    'æ°¸åº·æ‰€ âœ¦ å­ç³æ‰€é•·': 0, 'è¯å¹³æ‰€ âœ¦ ç‘œèæ‰€é•·': 0, 'å®‰å¹³æ‰€ âœ¦ ç§€å¦‚æ‰€é•·': 0,
                    'å–„åŒ–æ‰€ âœ¦ ææ•æ‰€é•·': 0, 'æ©‹é ­æ‰€ âœ¦ æƒ å©·æ‰€é•·': 0, 'å˜‰ç¾©æ‰€ âœ¦ ç¾ä¼¶æ‰€é•·': 0,
                    'ç¸½æ‰€ âœ¦ ç…’æ¾‚çµ„': 0, 'ç¸½æ‰€ âœ¦ ä½©åº­çµ„': 0, 'å»ºè¨­éƒ¨': 0
                },
                endTime: new Date("2026-03-06T12:00:00").getTime(),
                countdownText: "",
                isExpired: false
            }
        },
        mounted() {
            this.refreshData();
            this.updateTimer();
            setInterval(this.updateTimer, 1000);
            setInterval(this.refreshData, 30000);
        },
        computed: {
            sortedPlayers() {
                return Object.keys(this.playersData).map(n => ({ name: n, votes: this.playersData[n] }))
                    .sort((a, b) => b.votes - a.votes);
            },
            totalVotes() { return Object.values(this.playersData).reduce((a, b) => a + b, 0); }
        },
        methods: {
            refreshData() {
                votesRef.get().then((s) => {
                    const data = s.val();
                    if (data) Object.keys(this.playersData).forEach(k => { if(data[k] !== undefined) this.playersData[k] = data[k] });
                });
            },
            getPercent(v) { return this.totalVotes === 0 ? 0 : ((v / this.totalVotes) * 100).toFixed(1); },
            updateTimer() {
                const now = new Date().getTime();
                const diff = this.endTime - now;
                if (diff <= 0) { this.countdownText = "æŠ•ç¥¨å·²çµæŸ"; this.isExpired = true; return; }
                const d = Math.floor(diff / (1000 * 60 * 60 * 24)), h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)), m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)), s = Math.floor((diff % (1000 * 60)) / 1000);
                this.countdownText = `${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
            },
            handleVote(name) {
                if (this.hasVoted || this.isExpired) return;
                
                // 1. å¢åŠ ç¥¨æ•¸
                votesRef.child(name).transaction(v => (v || 0) + 1);
                
                // 2. å¯«å…¥è­‰æ“šç´€éŒ„
                logsRef.push({
                    target: name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    timeString: new Date().toLocaleString()
                });

                this.hasVoted = true;
                this.votedTarget = name;
                localStorage.setItem('voted_FINAL_2026', 'true');
                localStorage.setItem('voted_target_FINAL', name);
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#215440', '#d4af37'] });
                setTimeout(this.refreshData, 1000);
            }
        }
    }).mount('#app');
</script>
</body>
</html>
